---
title: "Data analysis with imputed data"
author: "R. Gaizauskaite"
format: html
editor: visual
---

### Libraries

```{r}
#| message: false
#| warning: false
library(tidyverse)
library(rstatix)
library(ggpubr)
library(gtsummary)
library(stats)
library(car)
library(corrr)
library(Hmisc)
library(corrplot)
library(ggtext)
library(ggcorrplot)
library(lmtest)
library(car)
library(carData)
library(MASS)
library(nortest)
```

### Data

```{r}
#| echo: false
#| output: false
CST_data <- read_csv("imputed_complete_data.csv")
```

Changing data types

```{r}
#| echo: false
CST_final <- CST_data |>  mutate(Group = as.factor(Group),
                                STEM = as.factor(STEM), 
                                Sex =  as.factor(Sex))
```

Changing group order

```{r}
# Define the desired order of factor levels
desired_order <- c("Men", "NCF", "NCL", "OC", "IUD" )

# Reorder the levels of the 'Group' factor variable
CST_final$Group <- fct_relevel(CST_final$Group, desired_order)

```

### Comments on data set

Some women were excluded from data analysis before hand. These were:

-   9 OC women due to usage of androgenic OC (Subject numbers: 2, 3, 4, 6, 7, 10, 17, 19, 26);
-   3 NCF women due to high values of progesterone (\> 150) and estradiol (\> 3), which signaled that they might be in different cycle phase than we expected (Subject numeber: (202, 210, 233)).
-   9 NCL women due to low values of progesterone (\< 87) showing that corpus luteal is not active.
-   1 (2 - gal dvi raÅ¡yti, nes vienai bloga buvo) IUD due to very low performance (6%, 2 correct of 30). Communication after task revealed that participant did not understood the task.

## 1. ANALYSIS

### 1.1. Demographic table

```{r}

Demographic_data <- CST_final |> dplyr::select(-Subject, -Sex, -CST)

demographic_summary_1 <- Demographic_data |>
  tbl_summary(
    by = Group,
    missing = "no",
    statistic = list(
      all_continuous() ~ "{mean} ({sd})"
    )
  ) |>
  add_p(
    test = all_continuous() ~ "aov",
    pvalue_fun = function(x) style_pvalue(x, digits = 2)
  )

demographic_summary_1
```

### 1.2. Running ANOVA

#### Homogeneity of regression slope

```{r}
CST_final |>  anova_test(CST ~ Group*Age*STEM)
```

No interaction between age, meaning the homogeneity in slopes

#### Normality of residuals 


```{r}
CST_final |>
  group_by(Group) |> 
  shapiro_test(CST)
```

```{r}
# Fit the model, the covariate goes first
model <- lm(CST ~ Group + STEM, data = CST_final)
# Inspect the model diagnostic metrics
model.metrics <- augment(model) %>%
  dplyr::select(-.hat, -.sigma, -.fitted) # Remove details
head(model.metrics, 3)
```

```{r}
shapiro_test(model.metrics$.resid)
```
```{r}
ad.test(model.metrics$.resid)
```

```{r}
plot(model)
```


**Homoscedasticity test**

```{r}
bptest(model)
```

Homoscedasticity assumption is not violated


#### ANOVA:

```{r}
CST_final <- CST_final |> 
  mutate(Group = fct_recode(Group, "Males" = "Men"))
```

```{r}
aov_1 <- CST_final |>  
  anova_test(CST ~ Age + STEM + Group)
get_anova_table(aov_1)
```

#### Pairwise comparison:

```{r}
pwc <- CST_final |> 
  emmeans_test(
    CST ~ Group, covariate = Age,
    p.adjust.method = "bonferroni"
    )
pwc
```

```{r}
#| echo: false
#| warning: false
pwc <- pwc |> add_xy_position(x = "Group")
Anova_result <- ggplot(CST_final, aes(Group, CST)) +
  geom_violin(aes(fill = Group), width = 1) +
  geom_boxplot(aes(fill = Group), width = 0.1, color = "black", alpha = 0.2) +
  geom_jitter(width = 0.3, height = 0, alpha = 0.5, color = "black") +
  labs(x = " ", y = "Accuracy, %") +
  scale_fill_manual(values = c("#0072B2", "#009E73", "#E69F00", "#999999", "#CC79A7")) +
  scale_y_continuous(limits = c(25, 110)) +  # Set y-axis limits
  theme_classic() +
  theme(axis.text = element_text(size = 14), legend.position = "none") +
  theme(axis.title = element_text(size = 18)) +
  stat_pvalue_manual(pwc, step.increase = 0.05, hide.ns = TRUE)


Anova_result


```

```{r}
# Identify the rows corresponding to the first pairwise comparison
pwc$y.position <- pwc$y.position+2


# Plot using the modified pwc data frame
Anova_result <- ggplot(CST_final, aes(Group, CST)) +
  geom_violin(aes(fill = Group), width = 1) +
  geom_boxplot(aes(fill = Group), width = 0.1, color = "black", alpha = 0.2) +
  geom_jitter(width = 0.3, height = 0, alpha = 0.5, color = "black") +
  labs(x = " ", y = "Accuracy, %") +
  scale_fill_manual(values = c("#0072B2", "#009E73", "#E69F00", "#999999", "#CC79A7")) +
  scale_y_continuous(limits = c(25, 115)) +  # Set y-axis limits
  theme_classic() +
  theme(axis.text = element_text(size = 14), legend.position = "none") +
  theme(axis.title = element_text(size = 18)) +
  stat_pvalue_manual(pwc, step.increase = 0.05, hide.ns = TRUE)

# Plot the ggplot object
print(Anova_result)

```



```{r}
ggsave("figures/Anova_result.png", Anova_result, width = 6, height = 4.5)
```

```{r}
CST_final |> 
  group_by(Group) |> 
  get_summary_stats(CST, type = "mean_se")
```

```{r}
CST_final |> 
  group_by(STEM) |> 
  get_summary_stats(CST, type = "mean_se")
```

### 1.3. Linear regression model

#### Women

##### Tidying the table

```{r}
#| echo: false
women_data <- CST_final |> filter(Sex == 1)
```

```{r}
#| echo: false
dummy_matrix <- model.matrix(~ Group - 1, data = women_data)
dummy_df <- as.data.frame(dummy_matrix)

#Combining the dummy variables with the original data
women_data <- cbind(women_data, dummy_df)


women_data <- women_data[, -19] 
```

renaming dummy variables

```{r}
women_data <- women_data |> rename(
  OC = GroupOC,
  IUD = GroupIUD,
  NCF = GroupNCF,
  NCL = GroupNCL
  )
```

```{r}
women_data <- women_data |> 
  mutate(
    OC = as.factor(OC),
    IUD = as.factor(IUD),
    NCF = as.factor(NCF),
    NCL = as.factor(NCL)
  )
```

##### Running first LM model with all the variables

```{r}
women_lm_model <- lm(CST~ OC + IUD + NCL + Age + STEM + PANAS_PA + PANAS_NA + EA1 + EA2 + Tiredness_1 + Tiredness_2 + Femininity + Masculinity + log(P4) + E2 +Tes, data = women_data)
```

```{r}
summary(women_lm_model)
```

##### Multicolinearity check up

```{r}
vif(women_lm_model)
```

All VIF score \< 3, no multicolinearity

##### AIC procedure

```{r}
stepAIC(women_lm_model, direction = "backward")
```

As model suggest IUD group to stay, i would do little bit differently and IUD group leave as reference group.

##### Final model

```{r}
women_final <- lm(CST ~ OC + NCF + NCL + STEM + EA2 + Femininity + Masculinity, data  = women_data)
```

```{r}
summary(women_final)
```

###### Assumptions

```{r}
#| echo: false
par(mfrow = c(2, 2))
plot(women_final)
```

**Normality of residuals**

```{r}
#| echo: false
#| output: false
model.metrics.women <- augment(women_final) |> 
  dplyr::select(-.hat, -.sigma, -.fitted)
```

```{r}
shapiro_test(model.metrics.women$.resid)
```

```{r}
ad.test(model.metrics.women$.resid)
```

**Conclusion:** Assumption of normality is not violated

**Homoscedasticity test**

```{r}
bptest(women_final)
```

**Conclusion:** homoscedacity assumption is not violated p \> 0.05

**Independence of Errors test:**

```{r}
durbinWatsonTest(women_final)
```

**Conclusion:** Independence of errors assumption is not violated p \< 0.05.

**Overall conclusion about model:**

There are some differences between imputed and not imputed data analysis. Main thing that AIC procedure suggest to leave masculinity and femininity data. The results of lm model suggest that STEM and masculinity score are not significant predictors.

Non of the assumptions of the model was violated, model looks as a good fit for a data eventhought it explains about \~16 proc. of the CST accuracy . Model reveals very interesting results showing that emotional arousal before CST was very strong negative predictor of the performance, and that women in IUD group differ from women in NCL. Also model revealed some expected results: higher femininity score show tendency of lowering CST score.

### Quadratic relationship between performance and testosterone in women

```{r}
quadratic_model_women <- lm(CST ~ poly(Tes, 2, raw = TRUE), data = women_data)
```

```{r}
summary(quadratic_model_women)
```

No polynomal relatioship

#### Men

##### Tidying the table

```{r}
#| echo: false
men_data <- CST_final |> filter(Sex == 2) 
```

##### Running first LM model with all the variables

```{r}
men_lm_model <- lm(CST~ Age + STEM + PANAS_PA + PANAS_NA + EA1 + EA2 + Tiredness_1 + Tiredness_2 + Femininity + Masculinity +Tes, data = men_data)
```

```{r}
summary(men_lm_model)
```

##### Multicolinearity check up

```{r}
vif(men_lm_model)
```

##### AIC procedure

```{r}
stepAIC(men_lm_model, direction = "backward")
```

##### Final model

```{r}
men_final <- lm(CST ~ EA1, data = men_data)
```

```{r}
summary(men_final)
```

###### Assumption

```{r}
#| echo: false
par(mfrow = c(2, 2))
plot(men_final)
```

**Normality of residuals**

```{r}
#| echo: false
#| output: false
model.metrics.men <- augment(men_final) |> 
  dplyr::select(-.hat, -.sigma, -.fitted)
```

```{r}
shapiro_test(model.metrics.men$.resid)
```

```{r}
ad.test(model.metrics.men$.resid)
```

**Conclusion:** Tricky situation in QQ graphic can be seen few values that probably effecting normality, especially lower values. *Shapiro-Wilk* test p \< 0.05, but in *Anderson-Darling* p \> 0.05. But it is just one predictor. Maybe, we can assume noramlity. Note for myself: **NEED TO REED MORE**

**Homoscedasticity test**

```{r}
bptest(men_final)
```

Probably 17, 24, 30 are "outliers" which are effecting homoscedacity

**Independence of Errors test:**

```{r}
durbinWatsonTest(men_final)
```

**Conclusion:** Independence of errors assumption is not violated p \< 0.05.

**Overall conclusion about model:** Not much of the difference from the data that was not imputed.

Interestingly model is left with just one predictor which is effect of EA at a begging of the experiment (positive effect). However, in the model some assumptions are violated: homescedacity and normality of residuals. Probably for prediction this model is not the best fit, however, if we are interested just in relationship, this model show that there is positive relationship between CST accuracy and EA1. And this model explains about 12% of variability in men CST performance data, which still is very interesting.

```{r}

men_lm <- ggplot(men_data, aes(x = EA1, y = CST)) +
  geom_point(size = 3, alpha = 0.7) +  # Adjusting point 
  geom_smooth(method = "lm", se = FALSE, color = "#0072B2", linetype = "dashed", size = 1.5) +  # Adjusting smooth line aesthetics
  theme_minimal() +
  labs(x = "EA1", y = "Accuracy, %", title = "y = 74.432 + 3.29X, p = 0.02 ") +  # Adding axis labels and title
  theme(plot.title = element_text(size = 14, face = "bold"),  # Adjusting title font size and style
        axis.text = element_text(size = 14),  # Adjusting axis text size
        axis.title = element_text(size = 18, face = "bold"))  # Adjusting axis title size and style
men_lm
```

```{r}
ggsave("figures/men_lm.png", men_lm, width = 6, height = 4.5)
```

### Quadratic relationshiop with testosterone

```{r}
quadratic_model_men <- lm(CST ~ poly(Tes, 2, raw = TRUE), data = men_data)
```

```{r}
summary(quadratic_model_men)
```
